{% extends "base.html" %}

{% load static %}
{% load widget_tweaks %}

{% block content %}

<link rel="stylesheet" href="{% static 'index/css/b4.css' %}">
<script src="{% static 'index/js/b4.js' %}"></script>


<div id="AgregarAutomovilModal" class="modal" style="overflow: scroll;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title text-dark">Agregar nuevo</h5>
            </div>
            <div class="modal-body bg-dark text-white">
                <form method="POST" action="{% url 'AddAutomovil' %}" enctype="multipart/form-data">{% csrf_token %}
                    {% for field in form_auto %}
                    <p>{{field.label}} <br>
                        {{field|add_class:"form-control text-dark"}}</p>
                    {% for error in field.errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
            </div>
            <div class="modal-footer bg-dark">
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-success">
                    Agregar
                </button>
            </div>
            </form>
        </div>
    </div>
</div>



<div id="EditarAutomovilModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title text-dark">Editar</h5>
            </div>
            <div class="modal-body bg-dark text-white">
                <form method="POST" action="{% url 'EditAutomovil' %}" enctype="multipart/form-data">{% csrf_token %}
                    <input type="hidden" id="id_automovil_editar" name="id_automovil_editar">
                    {% for field in form_editar %}
                    <p> {{field.label}} <br>
                        {{field|add_class:"form-control"}}</p>
                    {% for error in field.errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
            </div>
            <div class="modal-footer bg-dark text-white">
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                   Volver
                </button>
                <button type="submit" class="btn btn-success">
                    Aceptar
                </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="imprimirTicketModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title text-dark">Imprimir Ticket</h5>
            </div>
            <div class="modal-body bg-dark text-white">
                <form method="POST" action="{% url 'ImprimirTicket' %}" enctype="multipart/form-data">{% csrf_token %}
                    <input type="hidden" id="id_automovil_imprimir" name="id_automovil_imprimir">
                    <p> Hora Entrada: <br>
                        <input type="datetime-local" id="horaEntrada_imprimir" value="{{ i.horaEntrada}}" class="form-control" name="horaEntrada" readonly>
                    </p>
                    
                    <p> Hora Salida: <br>
                        <input type="datetime-local" id="horaSalida_imprimir" value="{{ i.horaSalida}}" class="form-control" name="horaSalida" readonly>
                    </p>

                    <p> Valor a Pagar: <br>
                        <input type="text" id="valor_a_pagar" class="form-control" name="valor_a_pagar" readonly>
                    </p>
                    {% for field in form_ticket_auto %}
                    <p> {{field.label}} <br>
                        {{field|add_class:"form-control"}}</p>
                    {% for error in field.errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                    <p class="alarma">{{error}}</p>
                    {% endfor %}
            </div>
            <div class="modal-footer bg-dark text-white">
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                   Volver
                </button>
                <button type="submit" class="btn btn-success">
                    Imprimir Ticket
                </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="EliminarAutomovilModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title text-dark">Eliminar</h5>
            </div>
            <div class="modal-body bg-dark text-white">
                <p class="labelmodal">¿Estás seguro?</p>
                <form method="POST" action="{% url 'DeleteAutomovil' %}">{% csrf_token %}
                    <input type="hidden" id="id_automovil_eliminar" name="id_automovil_eliminar">
            </div>
            <div class="modal-footer bg-dark text-white">
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                   Volver
                </button>
                <button type="submit" class="btn btn-success">
                    Aceptar
                </button>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-md-12">
        <h3 class="text-center">Automovil   <i class="fas fa-car-side"></i></h3>
        <div class="col-md-3 pb-2">
            <a href="#AgregarAutomovilModal"
                data-toggle="modal" data-dismiss="modal">
                <button type="button" class="btn btn-success">
                    Agregar Automovil
                    <i class="fas fa-plus-circle"></i>
                </button>
            </a>
        </div>
        <div class="card card-body" style="overflow:scroll">
            <table class="table table-hover table-primary" id="myTable">
                <thead>
                    <tr>
                        <th># ID</th>
                        <th>Placa</th>
                        <th>Modelo</th>
                        <th>Color</th>
                        <th>Hora Entrada</th>
                        <th>Hora Salida</th>
                    </tr>
                </thead>
                <tbody class="text-dark">
                    {% for i in autos %}
                    <tr>
                        <td>{{i.id}}</td>
                        <td>{{i.placa}}</td>
                        <td>{{i.modelo}}</td>
                        <td>{{i.color}}</td>
                        <td>{{ i.horaEntrada}}</td>
                        <td>{{i.horaSalida}}</td>
                        <td>
                            <button onclick="editarAuto('{{i.id}}', '{{i.placa}}','{{i.modelo}}', '{{i.color}}', '{{i.horaEntrada}}', '{{i.horaSalida}}',)" class="btn btn-dark-outline btn-sm" data-toggle="modal"
                                href="#EditarAutomovilModal"><img src="{% static 'index/img/editar.png' %}" alt="Error"
                                    width="30"></button>
                            <button onclick="eliminarAutomovil('{{i.id}}')" class="btn btn-dark-outline btn-sm"
                                data-toggle="modal" href="#EliminarAutomovilModal"><img
                                    src="{% static 'index/img/delete.png' %}" alt="Error" width="30"></button>
                            <button onclick="imprimirTicket('{{i.id}}','{{i.placa}}','{{i.horaEntrada}}','{{i.horaSalida}}',)" class="btn btn-dark-outline btn-sm"
                                data-toggle="modal" href="#imprimirTicketModal"><img
                                    src="{% static 'index/img/out.png' %}" alt="Error" width="30"></button>
                            
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% if messages %}
{% for message in messages %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error...',
        text: "{{message}}",
    })
</script>
{% endfor %}
{% endif %}
{% endblock %}

<script>
    function calcularValorAPagar() {
        const precioPorHora = 2000;  // Precio por hora (ajusta según tus necesidades)
        const horaEntradaStr = document.getElementById("horaEntrada_imprimir").value;
        const horaSalidaStr = document.getElementById("horaSalida_imprimir").value;
    
        if (horaEntradaStr && horaSalidaStr) {
            const horaEntrada = new Date(horaEntradaStr);
            const horaSalida = new Date(horaSalidaStr);
    
            // Calcular la diferencia en horas
            const diferenciaMilisegundos = horaSalida - horaEntrada;
            const diferenciaHoras = diferenciaMilisegundos / (1000 * 60 * 60);
    
            if (diferenciaHoras > 0) {
                // Calcular el valor a pagar
                const valorAPagar = diferenciaHoras * precioPorHora;
                document.getElementById("valor_a_pagar").value = valorAPagar.toFixed(2);
            } else {
                document.getElementById("valor_a_pagar").value = "0.00";
                alert("La hora de salida debe ser mayor que la hora de entrada.");
            }
        }
    }
    
    function imprimirTicket(id, placa, horaEntrada, horaSalida) {
        document.getElementById("id_automovil_imprimir").value = id;
        document.getElementById("horaEntrada_imprimir").value = horaEntrada;
        document.getElementById("horaSalida_imprimir").value = horaSalida;
    
        calcularValorAPagar(); // Calcular el valor al abrir el modal
    }
    </script>